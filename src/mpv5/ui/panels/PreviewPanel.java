package mpv5.ui.panels;

import com.sun.pdfview.PDFFile;
import com.sun.pdfview.PDFPage;
import com.sun.pdfview.PagePanel;
import java.awt.BorderLayout;
import java.io.File;
import java.io.FileNotFoundException;
import java.io.IOException;
import java.io.RandomAccessFile;
import java.nio.ByteBuffer;
import java.nio.channels.FileChannel;
import java.util.logging.Level;
import java.util.logging.Logger;
import javax.swing.JEditorPane;
import javax.swing.JFrame;
import mpv5.logging.Log;
import mpv5.ui.dialogs.BigPopup;
import mpv5.utils.files.FileReaderWriter;
import mpv5.utils.ooo.OOOPanel;

/**
 *
 * 
 */
public class PreviewPanel extends javax.swing.JPanel {

    private static final long serialVersionUID = 1L;

    /** Creates new form
     */
    public PreviewPanel() {
        initComponents();
    }

    /** Creates new preview for the given file. Currently supported file types:
     * <li>PDF
     * <li>ODT
     * <li>TXT
     * @param file
     */
    public PreviewPanel(File file) {
        initComponents();

        if (file.getName().split("\\.").length < 2) {
            throw new UnsupportedOperationException("The file must have an extension: " + file);
        }

        String extension = file.getName().substring(file.getName().lastIndexOf("."), file.getName().length());

        Log.Debug(this, "Found extension: " + extension);

        if (extension.equalsIgnoreCase(".pdf")) {
            try {
                openPdf(file);
            } catch (Exception ex) {
                Log.Debug(ex);
            }
        } else if (extension.equalsIgnoreCase(".odt")) {
            try {
                openOdt(file);
            } catch (Exception ex) {
                Log.Debug(ex);
            }
        } else if (extension.equalsIgnoreCase(".txt")) {
            try {
                open(file);
            } catch (Exception ex) {
                Log.Debug(ex);
            }
        } else {
            throw new UnsupportedOperationException("Extension not supported: " + extension);
        }
    }

    /**
     * Shows the given pdf file in the preview panel
     * @param pdf
     */
    public void openPdf(File pdf){
        if (pdf.isFile() && pdf.exists()) {
            try {
                initComponents();
                PagePanel panel = new PagePanel();
                ppanel.removeAll();
                ppanel.add(panel, BorderLayout.CENTER);
                ppanel.validate();

                if(getParent() instanceof  JFrame){
                        JFrame p = (JFrame) getParent();
                        p.pack();
                        p.setVisible(true);
                }

                RandomAccessFile raf = new RandomAccessFile(pdf, "r");
                FileChannel channel = raf.getChannel();
                ByteBuffer buf = channel.map(FileChannel.MapMode.READ_ONLY, 0, channel.size());
                PDFFile pdffile = new PDFFile(buf);
                buf.clear();
                channel.close();
                raf.close();
                // show the first page
                PDFPage page = pdffile.getPage(0);
                panel.showPage(page);
                panel.useZoomTool(true);
            } catch (IOException ex) {
                Log.Debug(ex);
            }
        } else {
            throw new IllegalArgumentException("File is not valid: " + pdf);
        }
    }

    /** This me4thod is called from within the constructor to
     * initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is
     * always regenerated by the Form Editor.
     */
    @SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        jPanel1 = new javax.swing.JPanel();
        ppanel = new javax.swing.JPanel();
        toolbar = new javax.swing.JToolBar();
        jButton27 = new javax.swing.JButton();
        jButton28 = new javax.swing.JButton();
        jButton29 = new javax.swing.JButton();
        jButton30 = new javax.swing.JButton();
        jButton31 = new javax.swing.JButton();
        jButton32 = new javax.swing.JButton();

        setName("Form"); // NOI18N

        java.util.ResourceBundle bundle = java.util.ResourceBundle.getBundle("mpv5/resources/languages/Panels"); // NOI18N
        jPanel1.setBorder(javax.swing.BorderFactory.createTitledBorder(bundle.getString("PreviewPanel.jPanel1.border.title"))); // NOI18N
        jPanel1.setName("jPanel1"); // NOI18N

        ppanel.setBorder(javax.swing.BorderFactory.createEtchedBorder());
        ppanel.setName("ppanel"); // NOI18N

        javax.swing.GroupLayout ppanelLayout = new javax.swing.GroupLayout(ppanel);
        ppanel.setLayout(ppanelLayout);
        ppanelLayout.setHorizontalGroup(
            ppanelLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGap(0, 535, Short.MAX_VALUE)
        );
        ppanelLayout.setVerticalGroup(
            ppanelLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGap(0, 130, Short.MAX_VALUE)
        );

        toolbar.setRollover(true);
        toolbar.setName("toolbar"); // NOI18N

        jButton27.setIcon(new javax.swing.ImageIcon(getClass().getResource("/mpv5/resources/images/32/printer.png"))); // NOI18N
        jButton27.setText(bundle.getString("PreviewPanel.jButton27.text")); // NOI18N
        jButton27.setToolTipText(bundle.getString("PreviewPanel.jButton27.toolTipText")); // NOI18N
        jButton27.setContentAreaFilled(false);
        jButton27.setFocusable(false);
        jButton27.setHorizontalTextPosition(javax.swing.SwingConstants.CENTER);
        jButton27.setName("jButton27"); // NOI18N
        jButton27.setVerticalTextPosition(javax.swing.SwingConstants.BOTTOM);
        jButton27.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                jButton27ActionPerformed(evt);
            }
        });
        toolbar.add(jButton27);

        jButton28.setIcon(new javax.swing.ImageIcon(getClass().getResource("/mpv5/resources/images/32/mail_reply.png"))); // NOI18N
        jButton28.setText(bundle.getString("PreviewPanel.jButton28.text")); // NOI18N
        jButton28.setToolTipText(bundle.getString("PreviewPanel.jButton28.toolTipText")); // NOI18N
        jButton28.setContentAreaFilled(false);
        jButton28.setFocusable(false);
        jButton28.setHorizontalTextPosition(javax.swing.SwingConstants.CENTER);
        jButton28.setName("jButton28"); // NOI18N
        jButton28.setVerticalTextPosition(javax.swing.SwingConstants.BOTTOM);
        jButton28.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                jButton28ActionPerformed(evt);
            }
        });
        toolbar.add(jButton28);

        jButton29.setIcon(new javax.swing.ImageIcon(getClass().getResource("/mpv5/resources/images/32/ximian-openoffice-writer.png"))); // NOI18N
        jButton29.setText(bundle.getString("PreviewPanel.jButton29.text")); // NOI18N
        jButton29.setToolTipText(bundle.getString("PreviewPanel.jButton29.toolTipText")); // NOI18N
        jButton29.setContentAreaFilled(false);
        jButton29.setFocusable(false);
        jButton29.setHorizontalTextPosition(javax.swing.SwingConstants.CENTER);
        jButton29.setName("jButton29"); // NOI18N
        jButton29.setVerticalTextPosition(javax.swing.SwingConstants.BOTTOM);
        jButton29.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                jButton29ActionPerformed(evt);
            }
        });
        toolbar.add(jButton29);

        jButton30.setIcon(new javax.swing.ImageIcon(getClass().getResource("/mpv5/resources/images/32/acroread.png"))); // NOI18N
        jButton30.setText(bundle.getString("PreviewPanel.jButton30.text")); // NOI18N
        jButton30.setToolTipText(bundle.getString("PreviewPanel.jButton30.toolTipText")); // NOI18N
        jButton30.setContentAreaFilled(false);
        jButton30.setFocusable(false);
        jButton30.setHorizontalTextPosition(javax.swing.SwingConstants.CENTER);
        jButton30.setName("jButton30"); // NOI18N
        jButton30.setVerticalTextPosition(javax.swing.SwingConstants.BOTTOM);
        jButton30.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                jButton30ActionPerformed(evt);
            }
        });
        toolbar.add(jButton30);

        jButton31.setIcon(new javax.swing.ImageIcon(getClass().getResource("/mpv5/resources/images/32/ark.png"))); // NOI18N
        jButton31.setText(bundle.getString("PreviewPanel.jButton31.text")); // NOI18N
        jButton31.setToolTipText(bundle.getString("PreviewPanel.jButton31.toolTipText")); // NOI18N
        jButton31.setContentAreaFilled(false);
        jButton31.setFocusable(false);
        jButton31.setHorizontalTextPosition(javax.swing.SwingConstants.CENTER);
        jButton31.setName("jButton31"); // NOI18N
        jButton31.setVerticalTextPosition(javax.swing.SwingConstants.BOTTOM);
        jButton31.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                jButton31ActionPerformed(evt);
            }
        });
        toolbar.add(jButton31);

        jButton32.setIcon(new javax.swing.ImageIcon(getClass().getResource("/mpv5/resources/images/32/fileexport.png"))); // NOI18N
        jButton32.setText(bundle.getString("PreviewPanel.jButton32.text")); // NOI18N
        jButton32.setToolTipText(bundle.getString("PreviewPanel.jButton32.toolTipText")); // NOI18N
        jButton32.setContentAreaFilled(false);
        jButton32.setFocusable(false);
        jButton32.setHorizontalTextPosition(javax.swing.SwingConstants.CENTER);
        jButton32.setName("jButton32"); // NOI18N
        jButton32.setVerticalTextPosition(javax.swing.SwingConstants.BOTTOM);
        jButton32.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                jButton32ActionPerformed(evt);
            }
        });
        toolbar.add(jButton32);

        javax.swing.GroupLayout jPanel1Layout = new javax.swing.GroupLayout(jPanel1);
        jPanel1.setLayout(jPanel1Layout);
        jPanel1Layout.setHorizontalGroup(
            jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addComponent(ppanel, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
            .addComponent(toolbar, javax.swing.GroupLayout.Alignment.TRAILING, javax.swing.GroupLayout.DEFAULT_SIZE, 539, Short.MAX_VALUE)
        );
        jPanel1Layout.setVerticalGroup(
            jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(jPanel1Layout.createSequentialGroup()
                .addComponent(toolbar, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addComponent(ppanel, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE))
        );

        javax.swing.GroupLayout layout = new javax.swing.GroupLayout(this);
        this.setLayout(layout);
        layout.setHorizontalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addComponent(jPanel1, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
        );
        layout.setVerticalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addComponent(jPanel1, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
        );
    }// </editor-fold>//GEN-END:initComponents

    private void jButton27ActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jButton27ActionPerformed
//        DatabaseObject dato = parents.getDataOwner();
//        if (dato.isExisting()) {
//            throw new UnsupportedOperationException("Mail not supported yet..");
//        }
}//GEN-LAST:event_jButton27ActionPerformed

    private void jButton28ActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jButton28ActionPerformed
        // TODO add your handling code here:
    }//GEN-LAST:event_jButton28ActionPerformed

    private void jButton29ActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jButton29ActionPerformed
        // TODO add your handling code here:
    }//GEN-LAST:event_jButton29ActionPerformed

    private void jButton30ActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jButton30ActionPerformed
        // TODO add your handling code here:
    }//GEN-LAST:event_jButton30ActionPerformed

    private void jButton31ActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jButton31ActionPerformed
        // TODO add your handling code here:
    }//GEN-LAST:event_jButton31ActionPerformed

    private void jButton32ActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jButton32ActionPerformed
        // TODO add your handling code here:
    }//GEN-LAST:event_jButton32ActionPerformed
    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JButton jButton27;
    private javax.swing.JButton jButton28;
    private javax.swing.JButton jButton29;
    private javax.swing.JButton jButton30;
    private javax.swing.JButton jButton31;
    private javax.swing.JButton jButton32;
    private javax.swing.JPanel jPanel1;
    private javax.swing.JPanel ppanel;
    private javax.swing.JToolBar toolbar;
    // End of variables declaration//GEN-END:variables

    public void openOdt(File file) {
        Log.Debug(this, "Preparing preview for: " + file);
        OOOPanel op = new OOOPanel();
        ppanel.removeAll();
        ppanel.add(op, BorderLayout.CENTER);

        op.constructOOOPanel(file);
        ppanel.validate();
    }

    public void open(File file) {
        FileReaderWriter f = new FileReaderWriter(file);
        String t = f.read();
        JEditorPane p = new JEditorPane();
        p.setText(t);
        ppanel.removeAll();
        ppanel.add(p, BorderLayout.CENTER);
        ppanel.validate();
    }

    /**
     * Show this panel in a new frame
     */
    public void showInNewFrame() {
        BigPopup p = new BigPopup();
        BigPopup.showPopup(this, jPanel1);
    }
}
